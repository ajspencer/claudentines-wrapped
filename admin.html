<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claudentines Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #0a0a0b;
            color: #e4e4e7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Login Screen ── */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }

        .login-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 380px;
            text-align: center;
        }

        .login-card h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .login-card .sub {
            font-size: 0.85rem;
            color: #71717a;
            margin-bottom: 28px;
        }

        .login-card input {
            width: 100%;
            padding: 14px 18px;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 10px;
            color: #fafafa;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 16px;
        }

        .login-card input:focus {
            border-color: #f74c89;
        }

        .login-card .error {
            color: #ef4444;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: none;
        }

        /* ── Buttons ── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f74c89, #e81b5b);
            color: white;
            padding: 14px 28px;
            width: 100%;
            font-size: 0.95rem;
        }

        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-sm {
            padding: 7px 14px;
            font-size: 0.75rem;
            border-radius: 8px;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid #27272a;
            color: #a1a1aa;
        }

        .btn-ghost:hover { border-color: #3f3f46; color: #e4e4e7; }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .btn-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .btn-success:hover { background: rgba(34, 197, 94, 0.2); }

        .btn-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .btn-warning:hover { background: rgba(234, 179, 8, 0.2); }

        /* ── Dashboard ── */
        .dashboard { display: none; }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            border-bottom: 1px solid #1e1e21;
            background: #111113;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar h1 {
            font-size: 1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar h1 span { color: #f74c89; }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 28px;
        }

        /* ── Stats Row ── */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 20px;
        }

        .stat-card .label {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #71717a;
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 900;
        }

        /* ── Table ── */
        .table-wrap {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 14px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 22px;
            border-bottom: 1px solid #27272a;
        }

        .table-header h2 {
            font-size: 1rem;
            font-weight: 800;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 12px 18px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #52525b;
            border-bottom: 1px solid #27272a;
        }

        tbody td {
            padding: 14px 18px;
            font-size: 0.85rem;
            border-bottom: 1px solid #1e1e21;
            vertical-align: middle;
        }

        tbody tr:last-child td { border-bottom: none; }

        tbody tr:hover { background: rgba(255,255,255,0.02); }

        .names-cell {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .names-cell .emoji {
            font-size: 1.3rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .badge-public {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }

        .badge-private {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        .badge-sample {
            background: rgba(99, 102, 241, 0.1);
            color: #818cf8;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ── Confirm Modal ── */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 16px;
            padding: 28px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .modal h3 {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .modal p {
            font-size: 0.85rem;
            color: #71717a;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-actions .btn { padding: 10px 24px; }

        /* ── Empty State ── */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #52525b;
        }

        .empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
        .empty p { font-size: 0.9rem; }

        /* ── Responsive ── */
        @media (max-width: 700px) {
            .main { padding: 20px 16px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            table { font-size: 0.8rem; }
            thead th, tbody td { padding: 10px 12px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>

<!-- ═══ LOGIN ═══ -->
<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <h1>Claudentines Admin</h1>
        <p class="sub">Enter the admin password to continue.</p>
        <div class="error" id="loginError">Wrong password. Try again.</div>
        <input type="password" id="passwordInput" placeholder="Password" autocomplete="off" autofocus>
        <button class="btn btn-primary" onclick="doLogin()">Sign In</button>
    </div>
</div>

<!-- ═══ DASHBOARD ═══ -->
<div class="dashboard" id="dashboard">
    <div class="topbar">
        <h1><span>&#9829;</span> Claudentines Admin</h1>
        <div class="topbar-right">
            <a href="/" class="btn btn-sm btn-ghost">View Site</a>
            <button class="btn btn-sm btn-ghost" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <div class="main">
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="label">Total Wrappeds</div>
                <div class="value" id="statTotal">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Public</div>
                <div class="value" id="statPublic">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Private</div>
                <div class="value" id="statPrivate">—</div>
            </div>
            <div class="stat-card">
                <div class="label">User Submitted</div>
                <div class="value" id="statUser">—</div>
            </div>
        </div>

        <div class="table-wrap">
            <div class="table-header">
                <h2>All Wrappeds</h2>
            </div>
            <div id="tableBody"></div>
        </div>
    </div>
</div>

<!-- ═══ CONFIRM DELETE MODAL ═══ -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h3>Delete this Wrapped?</h3>
        <p>This will permanently remove <strong id="deleteTargetName"></strong>. This can't be undone.</p>
        <div class="modal-actions">
            <button class="btn btn-sm btn-ghost" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-sm btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<script>
const passwordInput = document.getElementById('passwordInput');
passwordInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

let wrappeds = [];
let deleteTargetId = null;

// ── Auth ──
async function doLogin() {
    const pw = passwordInput.value;
    if (!pw) return;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';

    try {
        const res = await fetch('/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
        });
        if (!res.ok) {
            errEl.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
            return;
        }
        showDashboard();
    } catch {
        errEl.textContent = 'Connection error.';
        errEl.style.display = 'block';
    }
}

async function doLogout() {
    await fetch('/admin/logout', { method: 'POST' });
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    passwordInput.value = '';
    passwordInput.focus();
}

async function checkAuth() {
    try {
        const res = await fetch('/admin/api/check');
        if (res.ok) {
            showDashboard();
            return;
        }
    } catch {}
    // Show login
    document.getElementById('loginScreen').style.display = 'flex';
}

function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadWrappeds();
}

// ── Data ──
async function loadWrappeds() {
    try {
        const res = await fetch('/admin/api/wrappeds');
        if (res.status === 401) {
            doLogout();
            return;
        }
        wrappeds = await res.json();
        renderStats();
        renderTable();
    } catch (err) {
        console.error('Failed to load:', err);
    }
}

function renderStats() {
    const total = wrappeds.length;
    const pub = wrappeds.filter(w => w.is_public === 1).length;
    const priv = total - pub;
    const user = wrappeds.filter(w => w.is_sample !== 1).length;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statPublic').textContent = pub;
    document.getElementById('statPrivate').textContent = priv;
    document.getElementById('statUser').textContent = user;
}

function renderTable() {
    const container = document.getElementById('tableBody');

    if (wrappeds.length === 0) {
        container.innerHTML = '<div class="empty"><div class="icon">&#128148;</div><p>No wrappeds yet.</p></div>';
        return;
    }

    let html = `<table>
        <thead>
            <tr>
                <th>Wrapped</th>
                <th>Date Range</th>
                <th>Status</th>
                <th class="hide-mobile">Type</th>
                <th class="hide-mobile">Size</th>
                <th class="hide-mobile">Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>`;

    for (const w of wrappeds) {
        const date = new Date(w.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const sizeKb = w.html_size ? (w.html_size / 1024).toFixed(0) + ' KB' : (w.static_path ? 'Static file' : '—');
        const isPublic = w.is_public === 1;
        const isSample = w.is_sample === 1;

        html += `<tr>
            <td>
                <div class="names-cell">
                    <span class="emoji">${w.emoji || '&#128149;'}</span>
                    <a href="/w/${w.id}" target="_blank" style="color:#e4e4e7; text-decoration:none;">${escHtml(w.names)}</a>
                </div>
            </td>
            <td>${escHtml(w.date_range)}</td>
            <td>
                ${isPublic
                    ? '<span class="badge badge-public">&#9679; Public</span>'
                    : '<span class="badge badge-private">&#9679; Private</span>'}
            </td>
            <td class="hide-mobile">
                ${isSample ? '<span class="badge badge-sample">Sample</span>' : 'User'}
            </td>
            <td class="hide-mobile">${sizeKb}</td>
            <td class="hide-mobile">${date}</td>
            <td>
                <div class="actions">
                    ${isPublic
                        ? `<button class="btn btn-sm btn-warning" onclick="toggleVis('${w.id}', false)">Hide</button>`
                        : `<button class="btn btn-sm btn-success" onclick="toggleVis('${w.id}', true)">Show</button>`}
                    <button class="btn btn-sm btn-danger" onclick="openDeleteModal('${w.id}', '${escAttr(w.names)}')">Delete</button>
                </div>
            </td>
        </tr>`;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
}

// ── Actions ──
async function toggleVis(id, isPublic) {
    try {
        const res = await fetch(`/admin/api/wrappeds/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_public: isPublic })
        });
        if (res.ok) loadWrappeds();
    } catch (err) {
        console.error('Toggle failed:', err);
    }
}

function openDeleteModal(id, name) {
    deleteTargetId = id;
    document.getElementById('deleteTargetName').textContent = name;
    document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
    deleteTargetId = null;
    document.getElementById('deleteModal').classList.remove('show');
}

async function confirmDelete() {
    if (!deleteTargetId) return;
    try {
        const res = await fetch(`/admin/api/wrappeds/${deleteTargetId}`, { method: 'DELETE' });
        if (res.ok) {
            closeDeleteModal();
            loadWrappeds();
        }
    } catch (err) {
        console.error('Delete failed:', err);
    }
}

// Close modal on backdrop click
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) closeDeleteModal();
});

// ── Util ──
function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
}

function escAttr(s) {
    return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ── Init ──
checkAuth();
</script>
</body>
</html>
